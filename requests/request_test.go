package requests

import (
	"crypto/sha256"
	"testing"

	"github.com/docker/parsec/client/operations/asym_sign"
	"github.com/docker/parsec/client/operations/key_attributes"
	"github.com/docker/parsec/client/operations/ping"
	"gotest.tools/assert"
)

var expectedPingReq = []byte{
	0x10, 0xa7, 0xc0, 0x5e, 0x16, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
var expectedSignReq = []byte{
	0x10, 0xa7, 0xc0, 0x5e, 0x16, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x0a, 0x08, 0x74, 0x65, 0x73, 0x74, 0x5f, 0x6b, 0x65, 0x79, 0x10, 0x01, 0x1a, 0x28, 0x74, 0x65, 0x73, 0x74, 0x5f, 0x6d, 0x73, 0x67, 0xe3, 0xb0, 0xc4, 0x42, 0x98, 0xfc, 0x1c, 0x14, 0x9a, 0xfb, 0xf4, 0xc8, 0x99, 0x6f, 0xb9, 0x24, 0x27, 0xae, 0x41, 0xe4, 0x64, 0x9b, 0x93, 0x4c, 0xa4, 0x95, 0x99, 0x1b, 0x78, 0x52, 0xb8, 0x55}

func TestNewRequest(t *testing.T) {
	p := &ping.OpPingProto{}
	_, err := NewRequest(OpPing, p)
	assert.NilError(t, err)
}
func TestPackPing(t *testing.T) {
	p := &ping.OpPingProto{}
	r, err := NewRequest(OpPing, p)
	assert.NilError(t, err)
	b, err := r.Pack()
	assert.NilError(t, err)
	assert.DeepEqual(t, b.Bytes(), expectedPingReq)
}

func TestPackSign(t *testing.T) {
	s := "test_msg"
	h := sha256.New()
	d := h.Sum([]byte(s))
	p := &asym_sign.OpAsymmetricSignProto{
		KeyName:     "test_key",
		KeyLifetime: key_attributes.KeyLifetime_Persistent,
		Hash:        d}
	r, err := NewRequest(OpPing, p)
	assert.NilError(t, err)
	b, err := r.Pack()
	assert.NilError(t, err)
	assert.DeepEqual(t, b.Bytes(), expectedSignReq)
}
